default_platform(:ios)

platform :ios do
  desc "Setup Keychain for CI/CD"
  lane :setup_keychain do
    keychain_name = "fastlane_tmp.keychain"
    keychain_password = ""

    UI.message("ðŸ” Setting up keychain: #{keychain_name}")

    # Táº¡o keychain má»›i
    sh "security create-keychain -p \"#{keychain_password}\" #{keychain_name}"
    sh "security list-keychains -s #{keychain_name}"
    sh "security default-keychain -s #{keychain_name}"
    sh "security unlock-keychain -p \"#{keychain_password}\" #{keychain_name}"
    sh "security set-keychain-settings -t 3600 -u #{keychain_name}"

    UI.message("âœ… Keychain setup completed: #{keychain_name}")
  end

  desc "Push to TestFlight"
  lane :beta do
    # Gá»i keychain setup trÆ°á»›c khi báº¯t Ä‘áº§u
    setup_keychain

    # Äáº£m báº£o API Key tá»« Apple Ä‘Æ°á»£c thiáº¿t láº­p Ä‘Ãºng
    api_key = app_store_connect_api_key(
      key_id: "F2FJR735SW",
      issuer_id: "c25c9a94-3764-4ecf-b9d8-63408ce4989d",
      key_filepath: "./fastlane/AuthKey_F2FJR735SW.p8",
      duration: 1200,
      in_house: false
    )

    # Äáº·t MATCH_PASSWORD tá»« biáº¿n mÃ´i trÆ°á»ng
    ENV["MATCH_PASSWORD"] ||= "hihi"

    # Cáº¥u hÃ¬nh provisioning profile vá»›i match
    match(
      type: "appstore",
      app_identifier: "com.hat.profile",
      api_key: api_key,
      team_id: "6VLL82FXHY",
      keychain_name: "fastlane_tmp.keychain",
      readonly: false
    )

    # Cáº­p nháº­t cáº¥u hÃ¬nh signing trong Xcode
    update_code_signing_settings(
      use_automatic_signing: false,
      team_id: "6VLL82FXHY",
      code_sign_identity: "Apple Distribution",
      profile_name: "match AppStore com.hat.profile"
    )

    # Kiá»ƒm tra provisioning profile
    provisioning_profiles = Dir.glob(File.expand_path("~/Library/MobileDevice/Provisioning Profiles/*.mobileprovision"))
    
    if provisioning_profiles.empty?
      UI.user_error!("âŒ KhÃ´ng tÃ¬m tháº¥y provisioning profile nÃ o Ä‘Æ°á»£c táº£i vá»!")
    else
      UI.message("âœ… Danh sÃ¡ch provisioning profile Ä‘Ã£ táº£i vá»:")
      provisioning_profiles.each { |profile| UI.message("- #{profile}") }
    end

    # Build á»©ng dá»¥ng vá»›i Xcode
    build_ios_app(
      scheme: "hat-checker",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.hat.profile" => "match AppStore com.hat.profile"
        }
      },
      xcargs: "DEVELOPMENT_TEAM=6VLL82FXHY CODE_SIGN_IDENTITY='Apple Distribution' -allowProvisioningUpdates"
    )

    # Upload lÃªn TestFlight
    upload_to_testflight(
      api_key: api_key,
      app_identifier: "com.hat.profile"
    )

    UI.success("ðŸŽ‰ á»¨ng dá»¥ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº©y lÃªn TestFlight thÃ nh cÃ´ng!")
  end
end
